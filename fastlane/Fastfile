# Fastfile for ONDA iOS App
# This file automates building and deploying iOS app to TestFlight

default_platform(:ios)

platform :ios do
  before_all do
    # Ensure we're on the latest version of Fastlane
    update_fastlane
    
    # Setup App Store Connect API Key for authentication
    if ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"]
      # Read key content from file
      key_path = ENV["APP_STORE_CONNECT_API_KEY_KEY"]
      if key_path && File.exist?(key_path)
        key_content = File.read(key_path)
        puts "API Key file exists, size: #{key_content.length} bytes"
        puts "Key lines count: #{key_content.lines.count}"
        
        app_store_connect_api_key(
          key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
          issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
          key_content: key_content,
          in_house: false
        )
      else
        UI.user_error!("API Key file not found at: #{key_path}")
      end
    end
  end

  desc "Build iOS app"
  lane :build do
    # Install dependencies
    sh("cd .. && npm install")
    
    # Build React app
    sh("cd .. && npm run build")
    
    # Sync Capacitor
    sh("cd .. && npx cap sync ios")
    
    # Build the app
    gym(
      scheme: "App",
      workspace: "ios/App/App.xcworkspace",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "ONDA.ipa",
      clean: true,
      xcargs: "DEVELOPMENT_TEAM='#{ENV['FASTLANE_TEAM_ID']}' CODE_SIGN_STYLE=Manual CODE_SIGN_IDENTITY='Apple Distribution' PROVISIONING_PROFILE_SPECIFIER='match AppStore com.onda-life.ios'"
    )
  end

  desc "Build and upload to TestFlight"
  lane :beta do
    # Setup code signing with Match using API Key (no password needed)
    # First run: readonly=false to create certificates
    # After certificates exist: change to readonly=true for safety
    match(
      type: "appstore",
      readonly: is_ci ? false : true,
      force_for_new_devices: true,
      api_key_path: nil  # Uses api_key from before_all block
    )
    
    # Build the app
    build
    
    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      skip_submission: true,
      notify_external_testers: false
    )
    
    # Clean up build artifacts
    clean_build_artifacts
  end

  desc "Release to App Store"
  lane :release do
    # Setup code signing
    match(
      type: "appstore",
      readonly: true
    )
    
    # Build the app
    build
    
    # Upload to App Store
    upload_to_app_store(
      force: true,
      skip_metadata: true,
      skip_screenshots: true,
      submit_for_review: false
    )
    
    # Clean up
    clean_build_artifacts
  end

  desc "Setup Match for code signing"
  lane :setup_match do
    match(
      type: "development",
      readonly: false
    )
    
    match(
      type: "appstore",
      readonly: false
    )
  end

  after_all do |lane|
    # Success notification
    notification(
      title: "ONDA iOS",
      message: "Successfully completed '#{lane}' lane!"
    )
  end

  error do |lane, exception|
    # Error notification
    notification(
      title: "ONDA iOS Error",
      message: "Failed in '#{lane}' lane: #{exception.message}"
    )
  end
end
